<div fxFlex fxLayout="column">
  <form [formGroup]="form.get()">
    <div mat-dialog-title fxLayout="row">
      <!-- title input -->
      <mat-form-field id="title-container" floatPlaceholder="never" fxFlex>
        <input type="text" formControlName="title" matInput [matAutocomplete]="autocompleteTitle"
               placeholder="Task Title" required [disableControl]="!isTrelloProvider() || !form.isValid('intent')
               || (form.hasValue('intent.intendedAction','LINK') && !form.getValue('context.trelloTask'))">
        <mat-autocomplete #autocompleteTitle="matAutocomplete">
          <mat-option *ngFor="let title of autocomplete.titles.filtered" [value]="title">{{title}}</mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <!-- close icon -->
      <mat-icon (click)="closeDialog(task)" class="pointer">close</mat-icon>
    </div>

    <mat-dialog-content class="new-task-dialog">
      <mat-accordion [multi]="true" displayMode="flat" class="new-task-panel">

        <div formGroupName="intent" *ngIf="!isEditMode">
          <!-- provider input -->
          <mat-form-field>
            <mat-select formControlName="provider" required placeholder="Choose Provider"
                        (change)="onProviderSelect($event.value)" [disabled]="taskProviders.length < 2">
              <mat-option value="TRELLO" *ngIf="taskProviders.indexOf('trello') > -1">Trello</mat-option>
              <mat-option value="SOCIOCORTEX" *ngIf="taskProviders.indexOf('sociocortex') > -1">Connecare</mat-option>
            </mat-select>
          </mat-form-field>
          <!-- create/link input -->
          <mat-form-field>
            <mat-select formControlName="intendedAction" required placeholder="Choose Action"
                        (change)="onActionSelect()">
              <mat-option value="CREATE">Create new</mat-option>
              <mat-option value="LINK">Link existing</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- context -->
        <mat-expansion-panel [disabled]="!form.isValid('intent')" [expanded]="form.isValid('intent') && !isEditMode">
          <mat-expansion-panel-header expandedHeight="40px" collapsedHeight="40px">
            Context
          </mat-expansion-panel-header>
          <mat-divider class="expansion-divider"></mat-divider>
          <div formGroupName="context">
            <!-- TRELLO PROPERTIES -->
            <div *ngIf="isTrelloProvider() && (isEditMode || form.isValid('intent'))">
              <!-- board input -->
              <mat-form-field>
                <mat-select #initiallyFocused formControlName="trelloBoard" required placeholder="Board"
                            (change)="onBoardSelect($event.value)" [disableControl]="isEditMode">
                  <mat-option *ngFor="let board of autocomplete.trelloBoards" [value]="board.id">
                    {{board.name}}
                  </mat-option>
                  <mat-option *ngIf="autocomplete.trelloBoards.length < 1" disabled>
                    No boards available
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- list input -->
              <mat-form-field>
                <mat-select formControlName="trelloList" required placeholder="List"
                            [disableControl]="isEditMode || !form.getValue('context.trelloBoard')"
                            (change)="onListSelect($event.value)">
                  <mat-option *ngFor="let list of autocomplete.trelloLists.relevant" [value]="list.id">
                    {{list.name}}
                  </mat-option>
                  <mat-option *ngIf="autocomplete.trelloLists.relevant.length < 1" disabled>
                    No lists available
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- task input -->
              <mat-form-field *ngIf="form.hasValue('intent.intendedAction', 'LINK')">
                <mat-select formControlName="trelloTask" required placeholder="Task"
                            [disableControl]="!form.getValue('context.trelloList')"
                            (change)="onTaskSelect($event.value)">
                  <mat-option *ngFor="let task of autocomplete.trelloTasks" [value]="task.providerId">
                    {{task.name}}
                  </mat-option>
                  <mat-option *ngIf="autocomplete.trelloTasks.length < 1" disabled>
                    No tasks available
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <!-- SOCIOCORTEX PROPERTIES -->
            <div *ngIf="isSociocortexProvider()">
              <!-- workspace input -->
              <mat-form-field *ngIf="autocomplete.sociocortexWorkspaces.length > 1">
                <mat-select formControlName="sociocortexWorkspace" required placeholder="Workspace"
                            (change)="onWorkspaceSelect($event.value)" [disableControl]="isEditMode">
                  <mat-option *ngFor="let workspace of autocomplete.sociocortexWorkspaces" [value]="workspace.id">
                    {{workspace.name}}
                  </mat-option>
                  <mat-option *ngIf="autocomplete.sociocortexWorkspaces.length < 1" disabled>
                    No workspaces available
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- case input -->
              <mat-form-field>
                <mat-select formControlName="sociocortexCase" required placeholder="Case"
                            [disableControl]="isEditMode || !form.getValue('context.sociocortexWorkspace')"
                            (change)="onCaseSelect($event.value)">
                  <mat-option *ngFor="let sacmCase of autocomplete.sociocortexCases.relevant" [value]="sacmCase.id">
                    {{sacmCase.friendlyName}}
                  </mat-option>
                  <mat-option *ngIf="autocomplete.sociocortexCases.relevant.length < 1" disabled>
                    No cases available
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <!-- task input -->
              <mat-form-field *ngIf="!isEditMode">
                <mat-select formControlName="sociocortexTask" required placeholder="Task"
                            [disableControl]="isEditMode || !form.getValue('context.sociocortexCase')"
                            (change)="onTaskSelect($event.value)">
                  <mat-optgroup label="Open tasks" *ngIf="autocomplete.sociocortexTasks.open.length > 0">
                    <mat-option *ngFor="let task of autocomplete.sociocortexTasks.open" [value]="task.providerId">
                      {{task.name}}
                    </mat-option>
                  </mat-optgroup>
                  <mat-optgroup label="Completed tasks" *ngIf="autocomplete.sociocortexTasks.completed.length > 0">
                    <mat-option *ngFor="let task of autocomplete.sociocortexTasks.completed" [value]="task.providerId">
                      {{task.name}}
                    </mat-option>
                  </mat-optgroup>
                  <mat-option disabled
                              *ngIf="autocomplete.sociocortexTasks.open.length + autocomplete.sociocortexTasks.completed.length < 1">
                    No tasks available
                  </mat-option>
                </mat-select>

                <mat-optgroup label="Mentioned members" *ngIf="autocomplete.assignees.suggested.length > 0">
                  <mat-option *ngFor="let member of autocomplete.assignees.suggested" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>
                <mat-optgroup label="Board members" *ngIf="autocomplete.assignees.other.length > 0">
                  <mat-option *ngFor="let member of autocomplete.assignees.other" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>

              </mat-form-field>
            </div>
          </div>
        </mat-expansion-panel>
        <!-- metadata -->
        <mat-expansion-panel
          [disabled]="!form.isValid('intent') || (form.hasValue('intent.intendedAction','LINK') && !form.isValid('context'))">
          <mat-expansion-panel-header expandedHeight="40px" collapsedHeight="40px">
            Metadata
          </mat-expansion-panel-header>
          <mat-divider class="expansion-divider"></mat-divider>
          <div formGroupName="metadata">

            <!-- due date input -->
            <datepicker [dateControl]="form.get().get('metadata.dueDate')" placeholder="Due Date"
                        [autocompleteDates]="autocomplete.dates.asDates" [disabled]="isEditMode && !task.isOpen">
            </datepicker>

            <!-- Trello assignee input -->
            <mat-form-field *ngIf="isTrelloProvider()">
              <mat-icon class="assignee-icon" matPrefix>person</mat-icon>
              <mat-select class="margin" placeholder="Assignees" formControlName="assignees" name="member" fxFlex
                          multiple
                          [disableControl]="!form.getValue('context.trelloBoard') || (isEditMode && !task.isOpen)">
                <mat-optgroup label="Mentioned members" *ngIf="autocomplete.assignees.suggested.length > 0">
                  <mat-option *ngFor="let member of autocomplete.assignees.suggested" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>
                <mat-optgroup label="Board members" *ngIf="autocomplete.assignees.other.length > 0">
                  <mat-option *ngFor="let member of autocomplete.assignees.other" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>
                <mat-option *ngIf="autocomplete.assignees.other.length + autocomplete.assignees.suggested.length < 1"
                            disabled>
                  No assignees available
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Sociocortex owner input -->
            <mat-form-field *ngIf="isSociocortexProvider()">
              <mat-icon class="assignee-icon" matPrefix>person</mat-icon>
              <mat-select class="margin" placeholder="Owner" formControlName="assignees" name="member" fxFlex
                          [disableControl]="(!isEditMode && !form.getValue('context.sociocortexTask')) || (isEditMode && !task.isOpen)">
                <mat-optgroup label="Mentioned persons" *ngIf="autocomplete.owner.suggested.length > 0">
                  <mat-option *ngFor="let member of autocomplete.owner.suggested" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>
                <mat-optgroup label="Other possible owners" *ngIf="autocomplete.owner.other.length > 0">
                  <mat-option *ngFor="let member of autocomplete.owner.other" [value]="member.id">
                    {{member.fullName}}
                  </mat-option>
                </mat-optgroup>
                <mat-option *ngIf="autocomplete.owner.other.length + autocomplete.owner.suggested.length < 1" disabled>
                  No owners available
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-expansion-panel>

        <!-- content -->
        <mat-expansion-panel [expanded]="isEditMode"
                             [disabled]="!form.isValid('intent') || (form.hasValue('intent.intendedAction','LINK') && !form.isValid('context'))
        || (isSociocortexProvider() && (!this.form.getSociocortexParams() || this.form.getSociocortexParams().length == 0))">
          <mat-expansion-panel-header expandedHeight="40px" collapsedHeight="40px">
            Content
          </mat-expansion-panel-header>
          <mat-divider class="expansion-divider"></mat-divider>
          <task-content-trello *ngIf="isTrelloProvider()" [contentForm]="form.get().get('trelloContent')">
          </task-content-trello>
          <task-content-sociocortex *ngIf="this.form.getSociocortexParams()" [readOnly]="!task.isOpen"
                                    [taskParams]="this.form.getSociocortexParams()"
                                    [contentForm]="form.get().get('sociocortexContent')">
          </task-content-sociocortex>
        </mat-expansion-panel>
      </mat-accordion>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button type="button" [disabled]="submitted" mat-raised-button color="accent" (click)="onSubmit(false, false)"
              *ngIf="!task || !task._id || task.isOpen">
        <span *ngIf="!isEditMode" class="white-text">Confirm</span>
        <span *ngIf="isEditMode" class="white-text">Update</span>
        <!--<mat-spinner [diameter]="30" [strokeWidth]="4"></mat-spinner>-->
      </button>
      <button type="button" [disabled]="submitted" mat-raised-button *ngIf="isEditMode && task?.isOpen"
              (click)="onSubmit(true, false)">
        <span *ngIf="isSociocortexProvider()">Complete</span>
        <span *ngIf="isTrelloProvider()">Archive</span>
        <!--<mat-spinner [diameter]="30" [strokeWidth]="4"></mat-spinner>-->
      </button>
      <button type="button" [disabled]="submitted" mat-raised-button *ngIf="isEditMode && task?.isOpen"
              (click)="onSubmit(false, true)">
        <span *ngIf="isSociocortexProvider()">Terminate</span>
        <span *ngIf="isTrelloProvider()">Delete</span>
        <!--<mat-spinner [diameter]="30" [strokeWidth]="4"></mat-spinner>-->
      </button>
      <button type="button" [disabled]="submitted" mat-raised-button *ngIf="isEditMode"
              (click)="onUnlink()">
        <span>Unlink</span>
        <!--<mat-spinner [diameter]="30" [strokeWidth]="4"></mat-spinner>-->
      </button>
    </mat-dialog-actions>
  </form>
</div>
